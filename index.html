<!doctype html>
<html lang="ru">
<head>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ –º–∏–Ω–µ—Ä–∞–ª–æ–≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card:hover { transform: translateY(-1px); }
    .mono { font-variant-numeric: tabular-nums; }
    .sheet-closed { transform: translateY(110%); }
    .sheet-open { transform: translateY(0%); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col gap-3">
      <div class="flex items-center justify-between gap-3">
        <h1 class="text-lg sm:text-2xl font-semibold leading-tight">–ö–∞—Ç–∞–ª–æ–≥ –º–∏–Ω–µ—Ä–∞–ª–æ–≤</h1>
        <div class="hidden sm:block text-xs text-slate-500">Nikita Panin ¬∑ 2026</div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-12 gap-2">
        <div class="sm:col-span-8">
          <label class="text-xs text-slate-600">–ü–æ–∏—Å–∫</label>
          <input id="q" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
                 placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ, IMA, —Ñ–æ—Ä–º—É–ª–∞, –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ‚Ä¶" />
        </div>

        <div class="sm:col-span-4 flex items-end gap-2">
          <button id="openFilters"
                  class="w-full sm:hidden px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 shadow-sm flex items-center justify-between">
            <span>–§–∏–ª—å—Ç—Ä—ã</span>
            <span id="activeFiltersBadge" class="text-xs text-slate-600 mono">0</span>
          </button>

          <div class="hidden sm:block w-full">
            <label class="text-xs text-slate-600">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select id="sort_d" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
              <option value="name">–ù–∞–∑–≤–∞–Ω–∏–µ (–ê‚Üí–Ø)</option>
              <option value="cost_desc">–°—Ç–æ–∏–º–æ—Å—Ç—å (—É–±—ã–≤.)</option>
              <option value="cost_asc">–°—Ç–æ–∏–º–æ—Å—Ç—å (–≤–æ–∑—Ä.)</option>
              <option value="country_count">–°—Ç—Ä–∞–Ω–∞ (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É)</option>
              <option value="class_custom">–ö–ª–∞—Å—Å (–ø–æ—Ä—è–¥–æ–∫ –∫–∞—Ç–∞–ª–æ–≥–∞)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="hidden sm:grid grid-cols-12 gap-3">
        <div class="col-span-3">
          <label class="text-xs text-slate-600">–ö–ª–∞—Å—Å</label>
          <select id="fClass_d" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
        </div>
        <div class="col-span-3">
          <label class="text-xs text-slate-600">–°—Ç—Ä–∞–Ω–∞</label>
          <select id="fCountry_d" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
        </div>
        <div class="col-span-4">
          <label class="text-xs text-slate-600">–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ</label>
          <select id="fLocality_d" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
        </div>
        <div class="col-span-2">
          <label class="text-xs text-slate-600">–≠–ª–µ–º–µ–Ω—Ç</label>
          <select id="fEl_d" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
        </div>
      </div>

      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="text-sm text-slate-600">
          <span id="countLabel" class="mono"></span>
          <span class="mx-2 text-slate-300">‚Ä¢</span>
          <button id="reset" class="text-slate-700 hover:underline">–°–±—Ä–æ—Å–∏—Ç—å</button><button id="toggleCosts" class="ml-3 px-3 py-1.5 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-xs sm:text-sm">–°—Ç–æ–∏–º–æ—Å—Ç—å: —Å–∫—Ä—ã—Ç–æ</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-5">
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
        <div class="text-xs text-slate-500">–°–∞–º–º–∞—Ä–∏ (–ø–æ —Ç–µ–∫—É—â–µ–π –≤—ã–±–æ—Ä–∫–µ)</div>
        <div class="mt-2 grid grid-cols-2 gap-3">
          <div>
            <div class="text-xs text-slate-500">–û–±—Ä–∞–∑—Ü–æ–≤</div>
            <div id="sCount" class="text-lg font-semibold mono">‚Äî</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">–°—Ç—Ä–∞–Ω</div>
            <div id="sCountries" class="text-lg font-semibold mono">‚Äî</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π</div>
            <div id="sLocalities" class="text-lg font-semibold mono">‚Äî</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">–°—É–º–º. —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
            <div id="sTotalCost" class="text-lg font-semibold mono">‚Äî</div>
          </div>
        </div>
        <div class="mt-3 text-xs text-slate-500">* –°—Ç–æ–∏–º–æ—Å—Ç—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º.</div>

        <div id="costAnalytics" class="mt-4 pt-3 border-t border-slate-200">
          <div class="text-xs text-slate-500">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–ø–æ –≤—Å–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏)</div>
          <div class="mt-2 grid grid-cols-2 gap-3">
            <div>
              <div class="text-xs text-slate-500">–°—Ä–µ–¥–Ω—è—è</div>
              <div id="aAvg" class="text-lg font-semibold mono">‚Äî</div>
            </div>
            <div>
              <div class="text-xs text-slate-500">–ú–µ–¥–∏–∞–Ω–∞</div>
              <div id="aMed" class="text-lg font-semibold mono">‚Äî</div>
            </div>
          </div>

          <div class="mt-3">
            <div class="text-xs text-slate-500 mb-1">–ö–ª–∞—Å—Å (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤)</div>
            <select id="aClass" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
            <div id="aClassBody" class="mt-2 text-sm text-slate-700">
              –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å ‚Äî –ø–æ–∫–∞–∂—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –Ω–µ–º—É.
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm lg:col-span-2">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-xs text-slate-500">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∞—Å—Å–∞–º (—Ç–æ–ø-12)</div>
            <div class="text-sm text-slate-600">–ö–ª–∏–∫ –ø–æ –∫–ª–∞—Å—Å—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä</div>
          </div>
          <button id="showAllClasses" class="text-sm text-slate-700 hover:underline">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
        </div>
        <div id="classBars" class="mt-3 space-y-2"></div>
      </div>
    </section>

    <section>
      <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      <div class="flex items-center justify-center mt-6">
        <button id="more" class="hidden px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 shadow-sm">
          –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë
        </button>
      </div>
    </section>
  </main>

  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4 z-40">
    <div class="bg-white w-full max-w-2xl rounded-2xl border border-slate-200 shadow-xl">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <div class="font-semibold">–ö–ª–∞—Å—Å—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</div>
        <button id="closeModal" class="px-3 py-1 rounded-lg border border-slate-300 hover:bg-slate-50">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="modalBody" class="p-4 max-h-[70vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Bottom sheet (mobile filters) -->
  <div id="sheetBackdrop" class="fixed inset-0 hidden bg-black/40 z-50"></div>
  <div id="sheet" class="fixed left-0 right-0 bottom-0 z-50 sheet-closed transition-transform duration-200 ease-out">
    <div class="bg-white rounded-t-3xl border-t border-slate-200 shadow-2xl">
      <div class="max-w-7xl mx-auto px-4 pt-3 pb-2">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-3"></div>
        <div class="flex items-center justify-between">
          <div class="font-semibold">–§–∏–ª—å—Ç—Ä—ã</div>
          <button id="closeFilters" class="px-3 py-1 rounded-lg border border-slate-300 hover:bg-slate-50">–ì–æ—Ç–æ–≤–æ</button>
        </div>

        <div class="mt-3 grid grid-cols-1 gap-3 pb-3">
          <div>
            <label class="text-xs text-slate-600">–ö–ª–∞—Å—Å</label>
            <select id="fClass_m" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-xs text-slate-600">–°—Ç—Ä–∞–Ω–∞</label>
            <select id="fCountry_m" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-xs text-slate-600">–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ</label>
            <select id="fLocality_m" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-xs text-slate-600">–≠–ª–µ–º–µ–Ω—Ç –≤ —Ñ–æ—Ä–º—É–ª–µ</label>
            <select id="fEl_m" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-xs text-slate-600">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select id="sort_m" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
              <option value="name">–ù–∞–∑–≤–∞–Ω–∏–µ (–ê‚Üí–Ø)</option>
              <option value="cost_desc">–°—Ç–æ–∏–º–æ—Å—Ç—å (—É–±—ã–≤.)</option>
              <option value="cost_asc">–°—Ç–æ–∏–º–æ—Å—Ç—å (–≤–æ–∑—Ä.)</option>
              <option value="country_count">–°—Ç—Ä–∞–Ω–∞ (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É)</option>
              <option value="class_custom">–ö–ª–∞—Å—Å (–ø–æ—Ä—è–¥–æ–∫ –∫–∞—Ç–∞–ª–æ–≥–∞)</option>
            </select>
          </div>

          <div class="flex gap-2 pt-1">
            <button id="reset_m" class="w-1/2 px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50">–°–±—Ä–æ—Å–∏—Ç—å</button>
            <button id="apply_m" class="w-1/2 px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const CLASS_ORDER = {"—Å–∞–º–æ—Ä–æ–¥–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã": 0, "—Å—É–ª—å—Ñ–∏–¥—ã": 1, "—Å—É–ª—å—Ñ–æ–∞—Ä—Å–µ–Ω–∏—Ç—ã, —Å—É–ª—å—Ñ–æ–∞–Ω—Ç–∏–º–æ–Ω–∏—Ç—ã –∏ —Å—É–ª—å—Ñ–æ–≤–∏—Å–º—É—Ç–∏—Ç—ã": 2, "—Å—É–ª—å—Ñ–æ—Å–æ–ª–∏": 3, "–ø—Ä–æ—Å—Ç—ã–µ –≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã —Å h‚ÇÇo": 4, "–ø—Ä–æ—Å—Ç—ã–µ –≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã –±–µ–∑ h‚ÇÇo": 5, "—Å–ª–æ–∂–Ω—ã–µ –≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã": 6, "–æ–∫—Å–∏–ª- –∏ –≥–∏–¥—Ä–æ–∫—Å–∏–ª–≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã": 7, "–≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã": 8, "–æ–∫—Å–∏–¥—ã –º–µ—Ç–∞–ª–ª–æ–≤": 9, "–≥–∏–¥—Ä–æ–∫—Å–∏–¥—ã": 10, "—É—Ä–∞–Ω–∏–µ–≤—ã–µ –≥–∏–¥—Ä–æ–∫—Å–∏–¥—ã": 11, "–≤–∞–Ω–∞–¥–∞—Ç—ã": 12, "–∞—Ä—Å–µ–Ω–∏—Ç—ã, –∞–Ω—Ç–∏–º–æ–Ω–∏—Ç—ã, —Å—É–ª—å—Ñ–∏—Ç—ã, —Å–µ–ª–µ–Ω–∏—Ç—ã –∏ –ø—Ä.": 13, "–∏–æ–¥–∞—Ç—ã": 14, "–∫–∞—Ä–±–æ–Ω–∞—Ç—ã –±–µ–∑ h‚ÇÇo": 15, "–∫–∞—Ä–±–æ–Ω–∞—Ç—ã c h‚ÇÇo": 16, "—É—Ä–∞–Ω–∏–µ–≤—ã–µ –∫–∞—Ä–±–æ–Ω–∞—Ç—ã": 17, "–Ω–∏—Ç—Ä–∞—Ç—ã": 18, "–±–æ—Ä–∞—Ç—ã": 19, "—Å—É–ª—å—Ñ–∞—Ç—ã –±–µ–∑ h‚ÇÇo": 20, "—Å—É–ª—å—Ñ–∞—Ç—ã —Å h‚ÇÇo": 21, "—É—Ä–∞–Ω–∏–µ–≤—ã–µ —Å—É–ª—å—Ñ–∞—Ç—ã": 22, "—Ö—Ä–æ–º–∞—Ç—ã": 23, "–º–æ–ª–∏–±–¥–∞—Ç—ã –∏ –≤–æ–ª—å—Ñ—Ä–∞–º–∞—Ç—ã": 24, "—É—Ä–∞–Ω–∏–µ–≤—ã–µ –º–æ–ª–∏–±–¥–∞—Ç—ã –∏ –≤–æ–ª—å—Ñ—Ä–∞–º–∞—Ç—ã": 25, "—Ç–∏–æ—Å—É–ª—å—Ñ–∞—Ç—ã": 26, "—Å—É–ª—å—Ñ–∞—Ç—ã": 27, "—Ñ–æ—Å—Ñ–∞—Ç—ã –∏ –∞–Ω–∞–ª–æ–≥–∏ –±–µ–∑ h‚ÇÇo": 28, "—Ñ–æ—Å—Ñ–∞—Ç—ã –∏ –∞–Ω–∞–ª–æ–≥–∏ —Å h‚ÇÇo": 29, "—É—Ä–∞–Ω–∏–µ–≤—ã–µ —Ñ–æ—Å—Ñ–∞—Ç—ã –∏ –∞—Ä—Å–µ–Ω–∞—Ç—ã": 30, "–ø–æ–ª–∏—Ñ–æ—Å—Ñ–∞—Ç—ã –∏ –∞–Ω–∞–ª–æ–≥–∏": 31, "—Å–∏–ª–∏–∫–∞—Ç—ã": 32, "–æ—Å—Ç—Ä–æ–≤–Ω—ã–µ –æ—Ä—Ç–æ—Å–∏–ª–∏–∫–∞—Ç—ã": 33, "—Å–æ—Ä–æ—Å–∏–ª–∏–∫–∞—Ç—ã": 34, "–∫–æ–ª—å—Ü–µ–≤—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã": 35, "—Ü–µ–ø–æ—á–µ—á–Ω—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã": 36, "—Å–ª–æ–∏—Å—Ç—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã": 37, "–∫–∞—Ä–∫–∞—Å–Ω—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã –±–µ–∑ h‚ÇÇo": 38, "–∫–∞—Ä–∫–∞—Å–Ω—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã —Å h‚ÇÇo": 39, "–≥–µ—Ä–º–∞–Ω–∞—Ç—ã": 40, "–æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è": 41, "–≥–æ—Ä–Ω–∞—è –ø–æ—Ä–æ–¥–∞": 42, "–º–∏–Ω–µ—Ä–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": 43};
const state = { data: [], filtered: [], page: 0, pageSize: 60, countryCounts: new Map() };
const el = (id) => document.getElementById(id);
const fmtInt = (n) => (n ?? 0).toLocaleString('ru-RU');
const fmtMoney = (n) => (n == null || Number.isNaN(n)) ? '‚Äî' : (n.toLocaleString('ru-RU', {maximumFractionDigits: 0}) + ' ‚ÇΩ');
const norm = (s) => (s || '').toString().toLowerCase().trim();

function displayId(x) {
  // Same ID format as shown on the card: 4.1-A057-USA (UE band - col-ID - country code)
  const parts = [];
  if (x.ue_band) parts.push(String(x.ue_band).trim());
  if (x.id) parts.push(String(x.id).trim());
  if (x.country_code) parts.push(String(x.country_code).trim());
  return parts.filter(Boolean).join('-');
}


const PERIODIC = new Set(["H", "He", "Li", "Be", "B", "C", "N", "O", "F", "Ne", "Na", "Mg", "Al", "Si", "P", "S", "Cl", "Ar", "K", "Ca", "Sc", "Ti", "V", "Cr", "Mn", "Fe", "Co", "Ni", "Cu", "Zn", "Ga", "Ge", "As", "Se", "Br", "Kr", "Rb", "Sr", "Y", "Zr", "Nb", "Mo", "Tc", "Ru", "Rh", "Pd", "Ag", "Cd", "In", "Sn", "Sb", "Te", "I", "Xe", "Cs", "Ba", "La", "Ce", "Pr", "Nd", "Pm", "Sm", "Eu", "Gd", "Tb", "Dy", "Ho", "Er", "Tm", "Yb", "Lu", "Hf", "Ta", "W", "Re", "Os", "Ir", "Pt", "Au", "Hg", "Tl", "Pb", "Bi", "Po", "At", "Rn", "Fr", "Ra", "Ac", "Th", "Pa", "U", "Np", "Pu", "Am", "Cm", "Bk", "Cf", "Es", "Fm", "Md", "No", "Lr", "Rf", "Db", "Sg", "Bh", "Hs", "Mt", "Ds", "Rg", "Cn", "Nh", "Fl", "Mc", "Lv", "Ts", "Og"]);
function extractElementsFromFormulaText(formulaText) {
  const t = (formulaText || '').toString();
  const matches = t.match(/[A-Z][a-z]?/g) || [];
  const out = [];
  const seen = new Set();
  for (const sym of matches) {
    if (!PERIODIC.has(sym)) continue; // ignore non-elements (e.g., REE, etc.)
    if (seen.has(sym)) continue;
    seen.add(sym);
    out.push(sym);
  }
  return out;
}

// --- Cost lock (NOTE: this is UI-only; data.json still contains values) ---
const COST_PASSWORD_HASH = "e3a05765ec61974d3ae0ff2e3fef656f1591294f6500719eec22aad9968c8120"; // SHA-256("CHANGE_ME")

state.costUnlocked = sessionStorage.getItem('costUnlocked') === '1';

async function sha256Hex(str) {
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function updateCostUI() {
  const btn = el('toggleCosts');
  if (!btn) return;
  btn.textContent = state.costUnlocked ? '–°—Ç–æ–∏–º–æ—Å—Ç—å: –ø–æ–∫–∞–∑–∞–Ω–æ' : '–°—Ç–æ–∏–º–æ—Å—Ç—å: —Å–∫—Ä—ã—Ç–æ';
  // Disable/enable cost sorting options to avoid leaking via ordering
  const setCostSortDisabled = (selectEl) => {
    if (!selectEl) return;
    [...selectEl.options].forEach(opt => {
      if (opt.value === 'cost_desc' || opt.value === 'cost_asc') {
        opt.disabled = !state.costUnlocked;
        opt.textContent = state.costUnlocked
          ? (opt.value === 'cost_desc' ? '–°—Ç–æ–∏–º–æ—Å—Ç—å (—É–±—ã–≤.)' : '–°—Ç–æ–∏–º–æ—Å—Ç—å (–≤–æ–∑—Ä.)')
          : (opt.value === 'cost_desc' ? '–°—Ç–æ–∏–º–æ—Å—Ç—å (—É–±—ã–≤.) üîí' : '–°—Ç–æ–∏–º–æ—Å—Ç—å (–≤–æ–∑—Ä.) üîí');
      }
    });
    if (!state.costUnlocked && (selectEl.value === 'cost_desc' || selectEl.value === 'cost_asc')) {
      selectEl.value = 'name';
    }
  };
  setCostSortDisabled(el('sort_d'));
  setCostSortDisabled(el('sort_m'));
}

function openAuth() {
  el('authError')?.classList.add('hidden');
  el('authPassword').value = '';
  el('authModal').classList.remove('hidden');
  el('authModal').classList.add('flex');
  setTimeout(() => el('authPassword')?.focus(), 50);
}
function closeAuth() {
  el('authModal').classList.add('hidden');
  el('authModal').classList.remove('flex');
}
async function tryUnlock() {
  const pwd = (el('authPassword').value || '').trim();
  const h = await sha256Hex(pwd);
  if (h === COST_PASSWORD_HASH) {
    state.costUnlocked = true;
    sessionStorage.setItem('costUnlocked', '1');
    closeAuth();
    updateCostUI();
  updateAnalyticsUI();
    applyFilters();
    updateAnalyticsUI();
  } else {
    el('authError')?.classList.remove('hidden');
  }
}
function lockCosts() {
  state.costUnlocked = false;
  sessionStorage.removeItem('costUnlocked');
  updateCostUI();
  applyFilters();
  updateAnalyticsUI();
}

const CLASS_DIGIT_MAP = {"—Å–∞–º–æ—Ä–æ–¥–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã": "1", "—Å—É–ª—å—Ñ–∏–¥—ã": "2", "—Å—É–ª—å—Ñ–æ–∞—Ä—Å–µ–Ω–∏—Ç—ã, —Å—É–ª—å—Ñ–æ–∞–Ω—Ç–∏–º–æ–Ω–∏—Ç—ã –∏ —Å—É–ª—å—Ñ–æ–≤–∏—Å–º—É—Ç–∏—Ç—ã": "2", "—Å—É–ª—å—Ñ–æ—Å–æ–ª–∏": "2", "–ø—Ä–æ—Å—Ç—ã–µ –≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã —Å h‚ÇÇo": "3", "–ø—Ä–æ—Å—Ç—ã–µ –≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã –±–µ–∑ h‚ÇÇo": "3", "—Å–ª–æ–∂–Ω—ã–µ –≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã": "3", "–æ–∫—Å–∏–ª- –∏ –≥–∏–¥—Ä–æ–∫—Å–∏–ª–≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã": "3", "–≥–∞–ª–æ–≥–µ–Ω–∏–¥—ã": "3", "–æ–∫—Å–∏–¥—ã –º–µ—Ç–∞–ª–ª–æ–≤": "4", "–≥–∏–¥—Ä–æ–∫—Å–∏–¥—ã": "4", "—É—Ä–∞–Ω–∏–µ–≤—ã–µ –≥–∏–¥—Ä–æ–∫—Å–∏–¥—ã": "4", "–≤–∞–Ω–∞–¥–∞—Ç—ã": "4", "–∞—Ä—Å–µ–Ω–∏—Ç—ã, –∞–Ω—Ç–∏–º–æ–Ω–∏—Ç—ã, —Å—É–ª—å—Ñ–∏—Ç—ã, —Å–µ–ª–µ–Ω–∏—Ç—ã –∏ –ø—Ä.": "4", "–∏–æ–¥–∞—Ç—ã": "4", "–∫–∞—Ä–±–æ–Ω–∞—Ç—ã –±–µ–∑ h‚ÇÇo": "5", "–∫–∞—Ä–±–æ–Ω–∞—Ç—ã c h‚ÇÇo": "5", "—É—Ä–∞–Ω–∏–µ–≤—ã–µ –∫–∞—Ä–±–æ–Ω–∞—Ç—ã": "5", "–Ω–∏—Ç—Ä–∞—Ç—ã": "5", "–±–æ—Ä–∞—Ç—ã": "6", "—Å—É–ª—å—Ñ–∞—Ç—ã –±–µ–∑ h‚ÇÇo": "7", "—Å—É–ª—å—Ñ–∞—Ç—ã —Å h‚ÇÇo": "7", "—É—Ä–∞–Ω–∏–µ–≤—ã–µ —Å—É–ª—å—Ñ–∞—Ç—ã": "7", "—Ö—Ä–æ–º–∞—Ç—ã": "7", "–º–æ–ª–∏–±–¥–∞—Ç—ã –∏ –≤–æ–ª—å—Ñ—Ä–∞–º–∞—Ç—ã": "7", "—É—Ä–∞–Ω–∏–µ–≤—ã–µ –º–æ–ª–∏–±–¥–∞—Ç—ã –∏ –≤–æ–ª—å—Ñ—Ä–∞–º–∞—Ç—ã": "7", "—Ç–∏–æ—Å—É–ª—å—Ñ–∞—Ç—ã": "7", "—Å—É–ª—å—Ñ–∞—Ç—ã": "7", "—Ñ–æ—Å—Ñ–∞—Ç—ã –∏ –∞–Ω–∞–ª–æ–≥–∏ –±–µ–∑ h‚ÇÇo": "8", "—Ñ–æ—Å—Ñ–∞—Ç—ã –∏ –∞–Ω–∞–ª–æ–≥–∏ —Å h‚ÇÇo": "8", "—É—Ä–∞–Ω–∏–µ–≤—ã–µ —Ñ–æ—Å—Ñ–∞—Ç—ã –∏ –∞—Ä—Å–µ–Ω–∞—Ç—ã": "8", "–ø–æ–ª–∏—Ñ–æ—Å—Ñ–∞—Ç—ã –∏ –∞–Ω–∞–ª–æ–≥–∏": "8", "—Å–∏–ª–∏–∫–∞—Ç—ã": "9", "–æ—Å—Ç—Ä–æ–≤–Ω—ã–µ –æ—Ä—Ç–æ—Å–∏–ª–∏–∫–∞—Ç—ã": "9", "—Å–æ—Ä–æ—Å–∏–ª–∏–∫–∞—Ç—ã": "9", "–∫–æ–ª—å—Ü–µ–≤—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã": "9", "—Ü–µ–ø–æ—á–µ—á–Ω—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã": "9", "—Å–ª–æ–∏—Å—Ç—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã": "9", "–∫–∞—Ä–∫–∞—Å–Ω—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã –±–µ–∑ h‚ÇÇo": "9", "–∫–∞—Ä–∫–∞—Å–Ω—ã–µ —Å–∏–ª–∏–∫–∞—Ç—ã —Å h‚ÇÇo": "9", "–≥–µ—Ä–º–∞–Ω–∞—Ç—ã": "9", "–æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è": "10", "–≥–æ—Ä–Ω–∞—è –ø–æ—Ä–æ–¥–∞": "0", "–º–∏–Ω–µ—Ä–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": "0"};
const CARD_BG_MAP = {
  "0": "#ffffff",
  "10": "#ffffff",
  "1": "#F3F4F6",
  "2": "#FFF9D6",
  "3": "#E8FFF6",
  "4": "#FFF0F0",
  "5": "#F6F2FA",
  "6": "#EEF6FF",
  "7": "#FAF0E6",
  "8": "#F7F5F2",
  "9": "#F2F7F4"
};

function classDigitFromName(className) {
  const k = norm(className);
  if (!k) return "0";
  return CLASS_DIGIT_MAP[k] || "0";
}
function cardBgForClass(className) {
  const d = classDigitFromName(className);
  return CARD_BG_MAP[d] || "#ffffff";
}

function colorForClassName(className) {
  const d = classDigitFromName(className);
  return CARD_BG_MAP[d] || "#ffffff";
}

function brighten(hex, percent=45, satBoost=0.35) {
  // hex -> HSL, boost saturation and lightness slightly for visibility
  const num = parseInt(hex.slice(1), 16);
  let r = ((num >> 16) & 255) / 255;
  let g = ((num >> 8) & 255) / 255;
  let b = (num & 255) / 255;

  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h=0, s=0, l=(max+min)/2;

  if (max !== min) {
    const d = max - min;
    s = l > 0.5 ? d/(2-max-min) : d/(max+min);
    switch (max) {
      case r: h = (g-b)/d + (g < b ? 6 : 0); break;
      case g: h = (b-r)/d + 2; break;
      case b: h = (r-g)/d + 4; break;
    }
    h /= 6;
  }

  // boost
  s = Math.min(1, s + satBoost);
  l = Math.min(1, l + percent/100 * (1 - l));

  function hue2rgb(p,q,t){
    if(t<0) t+=1;
    if(t>1) t-=1;
    if(t<1/6) return p+(q-p)*6*t;
    if(t<1/2) return q;
    if(t<2/3) return p+(q-p)*(2/3-t)*6;
    return p;
  }

  let rr,gg,bb;
  if (s === 0) {
    rr=gg=bb=l;
  } else {
    const q = l < 0.5 ? l*(1+s) : l + s - l*s;
    const p = 2*l - q;
    rr = hue2rgb(p,q,h + 1/3);
    gg = hue2rgb(p,q,h);
    bb = hue2rgb(p,q,h - 1/3);
  }

  const R = Math.round(rr*255), G = Math.round(gg*255), B = Math.round(bb*255);
  return "#" + ((R<<16) | (G<<8) | B).toString(16).padStart(6,'0');
}

function scrollToCard(displayId) {
  // Ensure the card exists: reset filters, then progressively render more pages until found.
  if (typeof resetAll === 'function') resetAll();

  const targetId = 'card-' + displayId;

  setTimeout(() => {
    for (let i=0; i<30; i++) {
      const node = document.getElementById(targetId);
      if (node) break;

      const moreBtn = el('more');
      if (!moreBtn || moreBtn.classList.contains('hidden')) break;

      renderCards(false);
    }

    const node = document.getElementById(targetId);
    if (!node) return;

    node.scrollIntoView({ behavior: 'smooth', block: 'center' });
    node.classList.add('ring-2','ring-slate-900');
    setTimeout(() => node.classList.remove('ring-2','ring-slate-900'), 1500);
  }, 80);
}

function mindatUrl(item) {
  const q = encodeURIComponent(item.ima_name || item.name_ru || '');
  return `https://www.mindat.org/search.php?search=${q}`;
}
function uniqSorted(arr) { return [...new Set(arr.filter(x => x != null && x !== ''))].sort((a,b) => a.localeCompare(b, 'ru')); }
function makeOption(value, label) { const o=document.createElement('option'); o.value=value; o.textContent=label; return o; }
function fillSelect(selectEl, values, placeholder) { selectEl.innerHTML=''; selectEl.appendChild(makeOption('', placeholder)); values.forEach(v => selectEl.appendChild(makeOption(v,v))); }

function openSheet() {
  el('sheetBackdrop').classList.remove('hidden');
  el('sheet').classList.remove('sheet-closed');
  el('sheet').classList.add('sheet-open');
  document.body.style.overflow = 'hidden';
}
function closeSheet() {
  el('sheetBackdrop').classList.add('hidden');
  el('sheet').classList.add('sheet-closed');
  el('sheet').classList.remove('sheet-open');
  document.body.style.overflow = '';
}

function getFilterEls() {
  return {
    cls_d: el('fClass_d'), cls_m: el('fClass_m'),
    c_d: el('fCountry_d'), c_m: el('fCountry_m'),
    l_d: el('fLocality_d'), l_m: el('fLocality_m'),
    e_d: el('fEl_d'), e_m: el('fEl_m'),
    s_d: el('sort_d'), s_m: el('sort_m')
  };
}
function getCurrentFilters() {
  const fd = getFilterEls();
  const fClass = (fd.cls_m && fd.cls_m.value) || (fd.cls_d && fd.cls_d.value) || '';
  const fCountry = (fd.c_m && fd.c_m.value) || (fd.c_d && fd.c_d.value) || '';
  const fLocality = (fd.l_m && fd.l_m.value) || (fd.l_d && fd.l_d.value) || '';
  const fEl = (fd.e_m && fd.e_m.value) || (fd.e_d && fd.e_d.value) || '';
  const sort = (fd.s_m && fd.s_m.value) || (fd.s_d && fd.s_d.value) || 'name';
  return { fClass, fCountry, fLocality, fEl, sort };
}
function activeFiltersCount() {
  const f = getCurrentFilters();
  let n=0; if (f.fClass) n++; if (f.fCountry) n++; if (f.fLocality) n++; if (f.fEl) n++;
  return n;
}
function updateActiveBadge() {
  const b = el('activeFiltersBadge');
  if (b) b.textContent = String(activeFiltersCount());
}

function computeSummary(list) {
  const countries=new Set(), localities=new Set();
  let totalCost=0, costCount=0;
  list.forEach(x => {
    if (x.country) countries.add(x.country);
    if (x.locality) localities.add(x.locality);
    if (x.cost != null && !Number.isNaN(x.cost)) { totalCost += x.cost; costCount++; }
  });
  return { count:list.length, countries:countries.size, localities:localities.size, totalCost, avgCost: costCount ? totalCost/costCount : null };
}
function updateSummary(list) {
  const s=computeSummary(list);
  el('sCount').textContent=fmtInt(s.count);
  el('sCountries').textContent=fmtInt(s.countries);
  el('sLocalities').textContent=fmtInt(s.localities);
  el('sTotalCost').textContent = state.costUnlocked ? fmtMoney(s.totalCost) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  el('countLabel').textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${fmtInt(list.length)} –∏–∑ ${fmtInt(state.data.length)}`;
}

function classSortKey(cls) {
  const k = norm(cls);
  if (!k) return 1e9;
  if (k in CLASS_ORDER) return CLASS_ORDER[k];
  return 5e8;
}
function sortClassesForFilter(classes) {
  return classes.sort((a,b)=> {
    const ra=classSortKey(a), rb=classSortKey(b);
    if (ra !== rb) return ra-rb;
    return (a||'').localeCompare(b||'', 'ru');
  });
}

function groupByClass(list) {
  const m=new Map();
  list.forEach(x => { const k=x.class || '‚Äî'; m.set(k,(m.get(k)||0)+1); });
  return [...m.entries()].filter(([k])=>k!=='‚Äî').sort((a,b)=>b[1]-a[1]);
}
function renderClassBars(list) {
  const bars=el('classBars'); bars.innerHTML='';
  const grouped=groupByClass(list);
  const top=grouped.slice(0,12);
  const max=top.length ? top[0][1] : 1;
  top.forEach(([cls,cnt])=>{
    const row=document.createElement('button');
    row.className='w-full text-left p-2 rounded-xl hover:bg-slate-50 border border-slate-200';
    row.onclick=()=>{
      const fd = getFilterEls();
      if (fd.cls_m) fd.cls_m.value = cls;
      if (fd.cls_d) fd.cls_d.value = cls;
      applyFilters();
      window.scrollTo({top:0, behavior:'smooth'});
    };
    row.innerHTML = `
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm font-medium">${cls}</div>
        <div class="text-xs text-slate-500 mono">${fmtInt(cnt)}</div>
      </div>
      <div class="mt-2 h-2 rounded-full bg-slate-200 overflow-hidden">
        <div class="h-2 rounded-full" style="width:${Math.max(6, Math.round((cnt/max)*100))}%; background:${brighten(colorForClassName(cls),45,0.45)};"></div>
      </div>`;
    bars.appendChild(row);
  });
}

function openAllClassesModal(list) {
  const grouped=groupByClass(list);
  const body=el('modalBody'); body.innerHTML='';
  const grid=document.createElement('div');
  grid.className='grid grid-cols-1 sm:grid-cols-2 gap-2';
  grouped.forEach(([cls,cnt])=>{
    const b=document.createElement('button');
    b.className='p-3 rounded-xl border border-slate-200 hover:bg-slate-50 text-left';
    b.innerHTML=`<div class="font-medium">${cls}</div><div class="text-xs text-slate-500 mono">${fmtInt(cnt)} –æ–±—Ä–∞–∑—Ü–æ–≤</div>`;
    b.onclick=()=>{
      const fd = getFilterEls();
      if (fd.cls_m) fd.cls_m.value = cls;
      if (fd.cls_d) fd.cls_d.value = cls;
      closeModal(); applyFilters(); window.scrollTo({top:0, behavior:'smooth'});
    };
    grid.appendChild(b);
  });
  body.appendChild(grid);
  el('modal').classList.remove('hidden'); el('modal').classList.add('flex');
}
function closeModal(){ el('modal').classList.add('hidden'); el('modal').classList.remove('flex'); }

function brighten(hex, percent=45, satBoost=0.35) {
  // hex -> HSL, boost saturation and lightness slightly for visibility
  const num = parseInt(hex.slice(1), 16);
  let r = ((num >> 16) & 255) / 255;
  let g = ((num >> 8) & 255) / 255;
  let b = (num & 255) / 255;

  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h=0, s=0, l=(max+min)/2;

  if (max !== min) {
    const d = max - min;
    s = l > 0.5 ? d/(2-max-min) : d/(max+min);
    switch (max) {
      case r: h = (g-b)/d + (g < b ? 6 : 0); break;
      case g: h = (b-r)/d + 2; break;
      case b: h = (r-g)/d + 4; break;
    }
    h /= 6;
  }

  // boost
  s = Math.min(1, s + satBoost);
  l = Math.min(1, l + percent/100 * (1 - l));

  function hue2rgb(p,q,t){
    if(t<0) t+=1;
    if(t>1) t-=1;
    if(t<1/6) return p+(q-p)*6*t;
    if(t<1/2) return q;
    if(t<2/3) return p+(q-p)*(2/3-t)*6;
    return p;
  }

  let rr,gg,bb;
  if (s === 0) {
    rr=gg=bb=l;
  } else {
    const q = l < 0.5 ? l*(1+s) : l + s - l*s;
    const p = 2*l - q;
    rr = hue2rgb(p,q,h + 1/3);
    gg = hue2rgb(p,q,h);
    bb = hue2rgb(p,q,h - 1/3);
  }

  const R = Math.round(rr*255), G = Math.round(gg*255), B = Math.round(bb*255);
  return "#" + ((R<<16) | (G<<8) | B).toString(16).padStart(6,'0');
}

function scrollToCard(displayId) {
  // Ensure the card exists: reset filters, then progressively render more pages until found.
  if (typeof resetAll === 'function') resetAll();

  const targetId = 'card-' + displayId;

  setTimeout(() => {
    for (let i=0; i<30; i++) {
      const node = document.getElementById(targetId);
      if (node) break;

      const moreBtn = el('more');
      if (!moreBtn || moreBtn.classList.contains('hidden')) break;

      renderCards(false);
    }

    const node = document.getElementById(targetId);
    if (!node) return;

    node.scrollIntoView({ behavior: 'smooth', block: 'center' });
    node.classList.add('ring-2','ring-slate-900');
    setTimeout(() => node.classList.remove('ring-2','ring-slate-900'), 1500);
  }, 80);
}

function median(arr) {
  if (!arr.length) return null;
  const a = arr.slice().sort((x,y)=>x-y);
  const mid = Math.floor(a.length/2);
  return a.length % 2 ? a[mid] : (a[mid-1] + a[mid]) / 2;
}

function updateAnalyticsUI() {
  const aAvg = el('aAvg'), aMed = el('aMed'), aClass = el('aClass'), aBody = el('aClassBody');
  if (!aAvg || !aMed || !aClass || !aBody) return;

  if (!state.costUnlocked) {
    aAvg.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    aMed.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    aBody.innerHTML = `<div class="text-slate-600">üîí –°—Ç–æ–∏–º–æ—Å—Ç—å —Å–∫—Ä—ã—Ç–∞. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å (–∫–Ω–æ–ø–∫–∞ —Å–≤–µ—Ä—Ö—É), —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É.</div>`;
    return;
  }

  const priced = state.data.filter(x => x.cost != null && !Number.isNaN(x.cost)).map(x=>x.cost);
  const totalAll = priced.reduce((s,v)=>s+v,0);
  const avgAll = priced.length ? totalAll / priced.length : null;
  const medAll = median(priced);

  aAvg.textContent = avgAll == null ? '‚Äî' : fmtMoney(avgAll);
  aMed.textContent = medAll == null ? '‚Äî' : fmtMoney(medAll);

  const cls = aClass.value || '';
  if (!cls) {
    aBody.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å ‚Äî –ø–æ–∫–∞–∂—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –Ω–µ–º—É.';
    return;
  }

  const inClass = state.data.filter(x => x.class === cls && x.cost != null && !Number.isNaN(x.cost));
  const costs = inClass.map(x=>x.cost);
  const totalClass = costs.reduce((s,v)=>s+v,0);
  const avg = costs.length ? totalClass / costs.length : null;
  const med = median(costs);
  const share = totalAll ? (totalClass / totalAll) : null;

  const top = inClass.slice().sort((a,b)=>b.cost-a.cost).slice(0,3);
  const topHtml = top.length
    ? top.map(x => `<div class="flex items-center justify-between gap-3"><a href=\"#\" onclick=\"scrollToCard('${displayId(x)}'); return false;\" class=\"mono hover:underline\">${displayId(x)}</a><div class="mono">${fmtMoney(x.cost)}</div></div>`).join('')
    : `<div class="text-slate-500">–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å—Ç–æ–∏–º–æ—Å—Ç–µ–π –≤ —ç—Ç–æ–º –∫–ª–∞—Å—Å–µ.</div>`;

  aBody.innerHTML = `
    <div class="flex items-center justify-between gap-3"><div class="text-slate-500">–°—Ä–µ–¥–Ω—è—è</div><div class="mono font-semibold">${avg==null?'‚Äî':fmtMoney(avg)}</div></div>
    <div class="flex items-center justify-between gap-3"><div class="text-slate-500">–ú–µ–¥–∏–∞–Ω–∞</div><div class="mono font-semibold">${med==null?'‚Äî':fmtMoney(med)}</div></div>
    <div class="flex items-center justify-between gap-3"><div class="text-slate-500">–î–æ–ª—è –æ—Ç –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏</div><div class="mono font-semibold">${share==null?'‚Äî':(share*100).toFixed(1)+'%'}</div></div>
    <div class="mt-2 pt-2 border-t border-slate-200">
      <div class="text-xs text-slate-500 mb-1">–¢–æ–ø‚Äë3 —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö</div>
      <div class="space-y-1">${topHtml}</div>
    </div>
  `;
}

function applyFilters() {
  const q=norm(el('q').value);
  const f = getCurrentFilters();

  let out = state.data.filter(x=>{
    if (f.fClass && x.class !== f.fClass) return false;
    if (f.fCountry && x.country !== f.fCountry) return false;
    if (f.fLocality && x.locality !== f.fLocality) return false;
    if (f.fEl && !(x.elements || []).includes(f.fEl)) return false;

    if (!q) return true;
    const blob=[x.id, x.name_ru, x.name_other, x.ima_name, x.abbr, x.class, x.formula_text, x.locality, x.country].map(norm).join(' | ');
    return blob.includes(q);
  });

  const byStr=(k)=>(a,b)=>(a[k]||'').localeCompare(b[k]||'', 'ru');
  const byNum=(k,dir)=>(a,b)=>((a[k]==null? -Infinity:a[k]) - (b[k]==null? -Infinity:b[k])) * dir;

  if (f.sort==='name') out.sort(byStr('name_ru'));
  if (f.sort==='cost_desc') out.sort(byNum('cost', -1));
  if (f.sort==='cost_asc') out.sort(byNum('cost', 1));
  if (f.sort==='class_custom') out.sort((a,b)=>{
    const ra=classSortKey(a.class), rb=classSortKey(b.class);
    if (ra!==rb) return ra-rb;
    return (a.class||'').localeCompare(b.class||'', 'ru');
  });
  if (f.sort==='country_count') out.sort((a,b)=>{
    const ca = state.countryCounts.get(a.country||'') || 0;
    const cb = state.countryCounts.get(b.country||'') || 0;
    if (cb !== ca) return cb - ca;
    return (a.country||'').localeCompare(b.country||'', 'ru');
  });

  state.filtered=out;
  state.page=0;
  updateSummary(out);
  renderClassBars(out);
  updateActiveBadge();
  renderCards(true);
}

function cardHtml(x) {
  const title=x.name_ru || x.ima_name || '‚Äî';
  const subtitle=(x.ima_name && x.ima_name !== title) ? x.ima_name : '';
  const formula = x.formula_html ? x.formula_html : (x.formula_text || '');
  const cost=(x.cost != null && !Number.isNaN(x.cost)) ? (state.costUnlocked ? fmtMoney(x.cost) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢') : '‚Äî';
  const bg = cardBgForClass(x.class);

  return `
  <div id="card-${displayId(x)}" class="card rounded-2xl border border-slate-200 shadow-sm p-4 transition" style="background:${bg};">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="text-lg font-semibold leading-tight">${title}</div>
        ${subtitle ? `<div class="text-sm text-slate-600">${subtitle}</div>` : ``}
      </div>
      <div class="text-xs text-slate-500 mono">${displayId(x) || ''}</div>
    </div>

    <div class="mt-3 space-y-2 text-sm">
      ${x.name_other ? `<div class="text-slate-700">${x.name_other}</div>` : ``}
      ${x.class ? `<div><span class="text-slate-500">–ö–ª–∞—Å—Å:</span> ${x.class}</div>` : ``}
      ${x.country ? `<div><span class="text-slate-500">–°—Ç—Ä–∞–Ω–∞:</span> ${x.country}</div>` : ``}
      ${x.locality ? `<div><span class="text-slate-500">–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ:</span> ${x.locality}</div>` : ``}
      ${formula ? `<div><span class="text-slate-500">–§–æ—Ä–º—É–ª–∞:</span> <span class="mono">${formula}</span></div>` : ``}
      ${x.syngony ? `<div><span class="text-slate-500">–°–∏–Ω–≥–æ–Ω–∏—è:</span> ${x.syngony}</div>` : ``}
      ${x.discovery_year ? `<div><span class="text-slate-500">–ì–æ–¥ –æ—Ç–∫—Ä—ã—Ç–∏—è:</span> <span class="mono">${x.discovery_year}</span></div>` : ``}
    </div>

    <div class="mt-4 flex items-center justify-between gap-2">
      <div class="text-sm">
        <span class="text-slate-500">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
        <span class="font-semibold mono">${cost}</span>
      </div>
      <a class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-sm"
         href="${mindatUrl(x)}" target="_blank" rel="noreferrer">Mindat</a>
    </div>

    ${(x.elements && x.elements.length) ? `
      <div class="mt-3 flex flex-wrap gap-1">
        ${x.elements.slice(0, 10).map(e => `<button class="px-2 py-1 text-xs rounded-lg bg-slate-100 hover:bg-slate-200 mono" data-el="${e}">${e}</button>`).join('')}
        ${x.elements.length > 10 ? `<span class="text-xs text-slate-500">+${x.elements.length-10}</span>` : ``}
      </div>
    ` : ``}
  </div>`;
}

function renderCards(reset=false) {
  const cards=el('cards');
  if (reset) cards.innerHTML='';
  const start=state.page*state.pageSize;
  const end=Math.min(state.filtered.length, start + state.pageSize);
  const slice=state.filtered.slice(start, end);

  slice.forEach(x=>{
    const wrapper=document.createElement('div');
    wrapper.innerHTML=cardHtml(x);
    const card=wrapper.firstElementChild;
    card.querySelectorAll('button[data-el]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (el('fEl_m')) el('fEl_m').value = btn.getAttribute('data-el');
        if (el('fEl_d')) el('fEl_d').value = btn.getAttribute('data-el');
        applyFilters();
        window.scrollTo({top:0, behavior:'smooth'});
      });
    });
    cards.appendChild(card);
  });

  el('more').classList.toggle('hidden', end >= state.filtered.length);
  state.page += 1;
}

function resetAll() {
  el('q').value='';
  [['fClass_m','fClass_d'],['fCountry_m','fCountry_d'],['fLocality_m','fLocality_d'],['fEl_m','fEl_d']].forEach(([a,b])=>{ if (el(a)) el(a).value=''; if (el(b)) el(b).value=''; });
  if (el('sort_m')) el('sort_m').value='name';
  if (el('sort_d')) el('sort_d').value='name';
  applyFilters();
}

async function init() {
  const dataRes = await fetch('./data.json');
  state.data = await dataRes.json();

  // recompute elements from formula_text (periodic table only)
  state.data.forEach(x => { x.elements = extractElementsFromFormulaText(x.formula_text || ''); });

  // country counts for sorting
  const cc = new Map();
  state.data.forEach(x=>{ const c=x.country||''; if (!c) return; cc.set(c, (cc.get(c)||0)+1); });
  state.countryCounts = cc;

  const classes = sortClassesForFilter(uniqSorted(state.data.map(x=>x.class)));
  const countries = uniqSorted(state.data.map(x=>x.country));
  const localities = uniqSorted(state.data.map(x=>x.locality));
  const allEls = uniqSorted(state.data.flatMap(x => x.elements || []));

  fillSelect(el('fClass_d'), classes, '–í—Å–µ');
  fillSelect(el('fCountry_d'), countries, '–í—Å–µ');
  fillSelect(el('fLocality_d'), localities, '–í—Å–µ');
  fillSelect(el('fEl_d'), allEls, '–õ—é–±–æ–π');

  fillSelect(el('fClass_m'), classes, '–í—Å–µ');
  fillSelect(el('fCountry_m'), countries, '–í—Å–µ');
  fillSelect(el('fLocality_m'), localities, '–í—Å–µ');
  fillSelect(el('fEl_m'), allEls, '–õ—é–±–æ–π');

  // analytics class selector (independent from filters)
  if (el('aClass')) {
    fillSelect(el('aClass'), classes, '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å');
    el('aClass').addEventListener('change', updateAnalyticsUI);
  }

  el('q').addEventListener('input', ()=>applyFilters());

  [['fClass_d','fClass_m'],['fCountry_d','fCountry_m'],['fLocality_d','fLocality_m'],['fEl_d','fEl_m'],['sort_d','sort_m']]
    .forEach(([a,b])=>{ const A=el(a), B=el(b); if (A && B) A.addEventListener('change', ()=>{ B.value=A.value; applyFilters(); }); });

  [['fClass_m','fClass_d'],['fCountry_m','fCountry_d'],['fLocality_m','fLocality_d'],['fEl_m','fEl_d'],['sort_m','sort_d']]
    .forEach(([a,b])=>{ const A=el(a), B=el(b); if (A && B) A.addEventListener('change', ()=>{ B.value=A.value; applyFilters(); }); });

  el('more').addEventListener('click', ()=>renderCards(false));
  el('reset').addEventListener('click', resetAll);
  el('reset_m').addEventListener('click', resetAll);

  el('toggleCosts').addEventListener('click', ()=>{ if (state.costUnlocked) lockCosts(); else openAuth(); });
  el('apply_m').addEventListener('click', ()=>{ applyFilters(); closeSheet(); });

  el('showAllClasses').addEventListener('click', ()=>openAllClassesModal(state.filtered));
  el('closeModal').addEventListener('click', closeModal);
  el('modal').addEventListener('click', (e)=>{ if (e.target === el('modal')) closeModal(); });

  el('openFilters').addEventListener('click', openSheet);
  el('closeFilters').addEventListener('click', closeSheet);
  el('sheetBackdrop').addEventListener('click', closeSheet);


  /* auth wiring */
  if (el('closeAuth')) el('closeAuth').addEventListener('click', closeAuth);
  if (el('authCancel')) el('authCancel').addEventListener('click', closeAuth);
  if (el('authSubmit')) el('authSubmit').addEventListener('click', tryUnlock);
  if (el('authModal')) el('authModal').addEventListener('click', (e)=>{ if (e.target === el('authModal')) closeAuth(); });
  if (el('authPassword')) el('authPassword').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') tryUnlock(); });

  updateCostUI();

  state.filtered = state.data.slice();
  applyFilters();
}
init();
</script>

  <!-- Cost auth modal -->
  <div id="authModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4 z-50">
    <div class="bg-white w-full max-w-md rounded-2xl border border-slate-200 shadow-xl">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <div class="font-semibold">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
        <button id="closeAuth" class="px-3 py-1 rounded-lg border border-slate-300 hover:bg-slate-50">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="p-4 space-y-3">
        <div class="text-sm text-slate-600">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å (–¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏).</div>
        <input id="authPassword" type="password" autocomplete="current-password"
               class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
               placeholder="–ü–∞—Ä–æ–ª—å" />
        <div id="authError" class="hidden text-sm text-rose-600">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
        <div class="flex gap-2 pt-1">
          <button id="authCancel" class="w-1/2 px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50">–û—Ç–º–µ–Ω–∞</button>
          <button id="authSubmit" class="w-1/2 px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
